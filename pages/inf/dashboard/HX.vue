<template lang="pug">
div.monitor-dashboard(v-cloak)
  lah-header
    lah-transition(appear)
      .d-flex.justify-content-between.align-items-center.w-100
        .d-flex.align-items-center
          .my-auto {{ siteName }}ç›£æŽ§å„€è¡¨æ¿
          lah-button(
            v-b-modal.help-modal,
            icon="info",
            variant="outline-success",
            no-border,
            no-icon-gutter,
            title="èªªæ˜Ž"
          )

        .d-flex.align-items-center
          b-checkbox.mr-1.mt-2(
            v-model="col2",
            switch,
            size="lg"
          ) 2æ¬„é¡¯ç¤º
          .mr-1 ðŸ”´ {{ red }}
          .mr-1 ðŸŸ¡ {{ yellow }}
          .mr-1 ðŸŸ¢ {{ green }}
          b-button-group(size="lg")
            lah-button.mx-1(
              @click="$refs.setupModal.show()",
              icon="cog",
              variant="outline-secondary",
              action="clock",
              no-border,
              no-icon-gutter,
              title="è¨­å®šEMAILä¼ºæœå™¨"
            )
    lah-monitor-board-setup-modal(ref="setupModal")
    lah-help-modal(:modal-id="'help-modal'", size="lg", modal-title="æ™ºæ…§ç›£æŽ§å„€è¡¨æ¿èªªæ˜Ž")
      h5.d-flex.align-items-center
        lah-fa-icon(icon="lightbulb" regular, variant="secondary")
        span.ml-2 åŠŸèƒ½ç¸½è¦½
      p æœ¬å„€è¡¨æ¿æ—¨åœ¨æä¾›ä¸€å€‹é›†ä¸­å¼çš„ç›£æŽ§ç•«é¢ï¼Œå³æ™‚é¡¯ç¤ºå„é …ç³»çµ±æœå‹™èˆ‡ç¡¬é«”è¨­å‚™çš„å¥åº·ç‹€æ…‹ã€‚
      hr
      h5.d-flex.align-items-center
        lah-fa-icon(icon="traffic-light", variant="secondary")
        span.ml-2 ç‡ˆè™Ÿèˆ‡ç‹€æ…‹
      ul
        li é é¢é ‚ç«¯æœƒå³æ™‚çµ±è¨ˆç›®å‰æ‰€æœ‰ç›£æŽ§é …ç›®çš„ç‡ˆè™Ÿæ•¸é‡ï¼š
          ul
            li ðŸ”´ #[strong ç´…ç‡ˆ]ï¼šè¡¨ç¤ºç›£æŽ§é …ç›®ç™¼ç”Ÿåš´é‡éŒ¯èª¤æˆ–ä¸­æ–·ã€‚
            li ðŸŸ¡ #[strong é»ƒç‡ˆ]ï¼šè¡¨ç¤ºç›£æŽ§é …ç›®å‡ºç¾è­¦å‘Šæˆ–æ½›åœ¨å•é¡Œã€‚
            li ðŸŸ¢ #[strong ç¶ ç‡ˆ]ï¼šè¡¨ç¤ºç›£æŽ§é …ç›®é‹ä½œæ­£å¸¸ã€‚
        li ç•¶ç›£æŽ§é …ç›®å‡ºç¾ #[strong ç´…ç‡ˆ] æˆ– #[strong é»ƒç‡ˆ] æ™‚ï¼Œå…¶ç›£æŽ§é¢æ¿å°‡æœƒè‡ªå‹•ç½®é ‚ï¼Œä¸¦é€éŽå‹•ç•«æ•ˆæžœæé†’ç®¡ç†äººå“¡æ³¨æ„ã€‚
      hr
      h5.d-flex.align-items-center
        lah-fa-icon(icon="database", variant="secondary")
        span.ml-2 è³‡æ–™ä¾†æº
      p æœ¬å„€è¡¨æ¿é€éŽä»¥ä¸‹ä¸‰ç¨®æ–¹å¼ç²å–ç›£æŽ§æ•¸æ“šï¼š
      ol
        li #[strong é›»å­éƒµä»¶åˆ†æž]ï¼šè®€å–ç‰¹å®šéƒµä»¶ä¼ºæœå™¨çš„éƒµä»¶ï¼Œåˆ†æžä¸»æ—¨èˆ‡å…§å®¹ä¾†åˆ¤æ–·æœå‹™ç‹€æ…‹ï¼ˆä¾‹å¦‚ï¼šSRMASã€è³‡æ–™åº«å‚™ä»½ç­‰ï¼‰ã€‚
        li #[strong æ™ºæ…§ç›£æŽ§API]ï¼šå‘¼å«å®‰è£æ–¼é ç«¯ä¼ºæœå™¨ä¸Šçš„å®¢è£½åŒ–APIï¼Œç²å–æœå‹™çš„å³æ™‚ç‹€æ…‹ï¼ˆä¾‹å¦‚ï¼šå»ºç‰©åœ–ç±åŒæ­¥ã€åœ°ç±ç•°å‹•å³æ™‚é€šç­‰ï¼‰ã€‚
        li #[strong ç³»çµ±å¾Œç«¯API]ï¼šç›´æŽ¥å­˜å–æœ¬ç³»çµ±å¾Œç«¯çš„APIï¼ŒæŸ¥è©¢å…§éƒ¨æœå‹™ç‹€æ…‹ï¼ˆä¾‹å¦‚ï¼šL3åŒæ­¥ã€è·¨ç¸£å¸‚APæœå‹™ç­‰ï¼‰ã€‚
      hr
      h5.d-flex.align-items-center
        lah-fa-icon(icon="columns", variant="secondary")
        span.ml-2 ç‰ˆé¢é…ç½®
      ul
        li å‹¾é¸é é¦–çš„ #[strong 2æ¬„é¡¯ç¤º] é–‹é—œï¼Œå¯ä»¥å°‡å„€è¡¨æ¿åœ¨å…©æ¬„èˆ‡ä¸‰æ¬„ä¹‹é–“åˆ‡æ›ï¼Œä»¥é©æ‡‰ä¸åŒçš„èž¢å¹•å°ºå¯¸èˆ‡è§€çœ‹ç¿’æ…£ã€‚
      hr
      h5.d-flex.align-items-center
        lah-fa-icon(icon="cog", variant="secondary")
        span.ml-2 è¨­å®š
      ul
        li é»žæ“Š #[lah-fa-icon(icon="cog")] æŒ‰éˆ•å¯ä»¥è¨­å®šç”¨æ–¼ #[strong é›»å­éƒµä»¶åˆ†æž] çš„éƒµä»¶ä¼ºæœå™¨é€£ç·šè³‡è¨Šã€‚

  //- transition-group.d-flex.flex-wrap.justify-content-evenly(name="list-reverse")
  lah-flex-item-group
    //- common boards
    //- ä½¿ç”¨ CSS order å±¬æ€§é€²è¡ŒæŽ’åºï¼šç´…ç‡ˆ(-2) > é»ƒç‡ˆ(-1) > ç¶ ç‡ˆ(0)
    div(
      :class="colCss",
      :style="{ order: getOrder('LahMonitorBoardXap') }",
      key="lahMonitorBoardXap-fix"
    ): lah-monitor-board-xap(
      :class="heightCss",
      ref="LahMonitorBoardXap",
      @light-update="lightUpdate"
    )
    div(
      :class="colCss",
      :style="{ order: getOrder('LahMonitorBoardXapTrend') }",
      key="lahMonitorBoardXapTrend-fix"
    ): lah-monitor-board-xap-trend(
      watch-top-xap,
      :reload-time="15",
      @light-update="lightUpdate"
    )
    div(
      :class="colCss",
      :style="{ order: getOrder('lahMonitorBoardPowerha') }",
      key="lahMonitorBoardPowerha-fix"
    ): lah-monitor-board-powerha(
      :class="heightCss",
      ref="lahMonitorBoardPowerha",
      @light-update="lightUpdate",
      footer
    )
    div(
      :class="colCss",
      :style="{ order: getOrder('LahMonitorBoardDataguard') }",
      key="lahMonitorBoardDataguard-fix"
    ): lah-monitor-board-dataguard(
      :class="heightCss",
      ref="LahMonitorBoardDataguard",
      @light-update="lightUpdate",
      footer
    )
    div(
      :class="colCss",
      :style="{ order: getOrder('LahMonitorBoardSrmas') }",
      key="lahMonitorBoardSrmas-fix"
    ): lah-monitor-board-srmas.card-body-fixed-height-3.fix-img(
      ref="LahMonitorBoardSrmas",
      @light-update="lightUpdate",
      footer
    )
    div(
      :class="colCss",
      :style="{ order: getOrder('LahMonitorBoardHacmp') }",
      key="lahMonitorBoardHacmp-fix"
    ): lah-monitor-board-hacmp(
      :class="heightCss",
      ref="LahMonitorBoardHacmp",
      @light-update="lightUpdate",
      footer
    )
    div(
      :class="colCss",
      :style="{ order: getOrder('LahMonitorBoardSmsNotify') }",
      key="lahMonitorBoardSmsNotify-fix"
    ): lah-monitor-board-sms-notify(
      :class="heightCss",
      ref="LahMonitorBoardSmsNotify",
      @light-update="lightUpdate",
      footer
    )
    div(
      :class="colCss",
      :style="{ order: getOrder('LahMonitorBoardSms') }",
      key="lahMonitorBoardSms-fix"
    ): lah-monitor-board-sms(
      :class="heightCss",
      ref="LahMonitorBoardSms",
      @light-update="lightUpdate",
      footer
    )
    div(
      :class="colCss",
      :style="{ order: getOrder('LahMonitorBoardL05') }",
      key="lahMonitorBoardL05-fix"
    ): lah-monitor-board-L05(
      :class="heightCss",
      ref="LahMonitorBoardL05",
      @light-update="lightUpdate",
      footer
    )
    div(
      :class="colCss",
      :style="{ order: getOrder('LahMonitorBoardApbackup') }",
      key="lahMonitorBoardApbackup-fix"
    ): lah-monitor-board-apbackup(
      :class="heightCss",
      ref="LahMonitorBoardApbackup",
      @light-update="lightUpdate",
      footer
    )
    div(
      :class="colCss",
      :style="{ order: getOrder('LahMonitorBoardXcaseSync') }",
      key="lahMonitorBoardXcaseSync-fix"
    ): lah-monitor-board-xcase-sync(
      :class="heightCss",
      ref="LahMonitorBoardXcaseSync",
      @light-update="lightUpdate"
    )
    div(
      :class="colCss",
      :style="{ order: getOrder('LahMonitorBoardSiteHx') }",
      key="lahMonitorBoardSiteHx-fix"
    ): lah-monitor-board-site-hx(
      :class="heightCss",
      ref="LahMonitorBoardSiteHx",
      @light-update="lightUpdate"
    )
    div(
      :class="colCss",
      :style="{ order: getOrder('LahMonitorBoardLxhweb') }",
      key="lahMonitorBoardLxhweb-fix"
    ): lah-monitor-board-lxhweb(
      :class="heightCss",
      ref="LahMonitorBoardLxhweb",
      @light-update="lightUpdate",
      target-ip="L3HWEB",
      link,
      display-update-time
    )
    div(
      :class="colCss",
      :style="{ order: getOrder('LahMonitorBoardSiteTw') }",
      key="lahMonitorBoardSiteTw-fix"
    ): lah-monitor-board-site-tw(
      :class="heightCss",
      ref="LahMonitorBoardSiteTw",
      @light-update="lightUpdate"
    )
    div(
      :class="colCss",
      :style="{ order: getOrder('LahMonitorBoardDbbackup') }",
      key="lahMonitorBoardDbbackup-fix"
    ): lah-monitor-board-dbbackup(
      :class="heightCss",
      ref="LahMonitorBoardDbbackup",
      @light-update="lightUpdate",
      footer
    )
    div(
      :class="colCss",
      :style="{ order: getOrder('LahMonitorBoardConnectivity') }",
      key="lahMonitorBoardConnectivity-fix"
    ): lah-monitor-board-connectivity(
      :class="heightCss",
      ref="LahMonitorBoardConnectivity",
      @light-update="lightUpdate"
    )
</template>

<script>
export default {
  // middleware: ['isInf'], // authority control
  data: () => ({
    red: 0,
    yellow: 0,
    green: 0,
    attentionList: [],
    attentionTimer: null,
    topWarning: true,
    col2: false
  }),
  head: {
    title: 'æ™ºæ…§ç›£æŽ§å„€è¡¨æ¿-æ¡ƒåœ’å¸‚åœ°æ”¿å±€'
  },
  computed: {
    colCss () {
      return this.col2 ? ['col-md-6'] : ['col-md-4']
    },
    heightCss () {
      return this.col2 ? ['card-body-fixed-height-2'] : ['card-body-fixed-height-3']
    },
    dangerList () {
      return this.attentionList.filter((item) => {
        return item.state === 'danger'
      })
    },
    warningList () {
      return this.attentionList.filter((item) => {
        return item.state === 'warning'
      })
    },
    highlightCount () {
      return this.attentionList.length
    },
    lightMap () {
      return this.$store.getters['inf/monitorLightMap']
    },
    connectionText () {
      // bureau ssl mail server needs this
      if (this.systemConfigs?.monitor?.ssl) {
        return `${this.systemConfigs?.monitor?.account}@{${this.systemConfigs?.monitor?.host}:993/imap/ssl/novalidate-cert}INBOX`
      }
      return `${this.systemConfigs?.monitor?.account}@{${this.systemConfigs?.monitor?.host}/novalidate-cert}INBOX`
    }
  },
  watch: {
    col2 (flag) {
      this.setCache('dashboard-col2', flag)
    }
  },
  created () {
    this.getCache('dashboard-col2').then((flag)=> {
      this.col2 = flag
    })
  },
  mounted () {
    this.refreshHighlightGroup = this.$utils.debounce(() => {
      // to add warning/danger card to highlight group
      const tmp = []
      for (const [key, value] of this.lightMap) {
        if (['warning', 'danger'].includes(value)) {
          tmp.push({
            compName: key.charAt(0).toLowerCase() + key.slice(1),
            state: value
          })
        }
      }
      // order by state
      this.attentionList = this.$utils.orderBy(tmp, 'state')
    }, 5000)
    // using animation to catch attention
    this.attentionTimer = setInterval(() => {
      this.dangerList.forEach((card) => {
        this.timeout(
          // 'slower', 'slow', '', 'fast', 'faster' (3s, 2s, 1s, 800ms, 500ms)
          () => this.attention(`#${card.compName}-attention`, { speed: '1s' }),
          this.$utils.rand(15) * 1000
        )
      })
      this.warningList.forEach((card) => {
        this.timeout(
          // 'slower', 'slow', '', 'fast', 'faster' (3s, 2s, 1s, 800ms, 500ms)
          () => this.attention(`#${card.compName}-attention`, { name: 'headShake' }),
          this.$utils.rand(15) * 1000
        )
      })
    }, 30 * 1000)
  },
  beforeDestroy () {
    clearInterval(this.attentionTimer)
  },
  methods: {
    lightUpdate (payload) {
      this.lightMap.set(payload.name, payload.new)
      const tmp = [...this.lightMap]
      this.green = tmp.reduce((acc, item) => {
        return item[1] === 'success' ? acc + 1 : acc
      }, 0)
      this.yellow = tmp.reduce((acc, item) => {
        return item[1] === 'warning' ? acc + 1 : acc
      }, 0)
      this.red = tmp.reduce((acc, item) => {
        return item[1] === 'danger' ? acc + 1 : acc
      }, 0)
      this.refreshHighlightGroup()
    },
    refreshHighlightGroup () { /* placeholder for debouncing */ },
    isInAttention (name) {
      const clean = name[0]?.toUpperCase() + name?.slice(1)
      return this.lightMap.has(clean) &&
             this.lightMap.get(clean) !== 'success'
    },
    isFooterEnable (name) {
      if (name) {
        const opts = this.$refs[`${name[0]?.toUpperCase() + name?.slice(1)}`]?.$options
        const footer = opts?.propsData?.footer
        return footer
      }
      return false
    },
    /**
     * Determines the visual order of the component based on its status.
     * Flexbox order: smaller number comes first.
     * Danger (Red): -2
     * Warning (Yellow): -1
     * Normal (Green/Success): 0
     */
    getOrder (name) {
      if (!name) return 0
      // normalized camelCase name to match what is stored in attentionList
      const camel = name.charAt(0).toLowerCase() + name.slice(1)
      const item = this.attentionList.find(x => x.compName === camel)
      if (item) {
        if (item.state === 'danger') return -2
        if (item.state === 'warning') return -1
      }
      return 0
    }
  }
}
</script>

<style lang="scss">
.monitor-dashboard {
  /* Ignored desktop font size settings */
  -webkit-text-size-adjust: 100%;
  -moz-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
  text-size-adjust: 100%;
  /* Force a base font size to avoid system scaling issues that break fixed-height layouts */
  font-size: 16px;
}
.highlight-group {
  border-bottom: 2px dashed gray;
  margin-bottom: 15px;
}
.col-md-4 > .card {
  height: calc((100vh - 150px) / 3);
  overflow: auto;
  margin-bottom: 1rem;
}
.col-md-6 > .card {
  height: calc((100vh - 150px) / 2);
  overflow: auto;
  margin-bottom: 1rem;
}
.fix-img {
  img {
    height: calc(100vh / 3 - 200px);
  }
}
</style>