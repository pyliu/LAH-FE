<template lang="pug">
client-only: .monitor-dashboard(v-cloak)
  lah-header
    lah-transition(appear)
      .d-flex.justify-content-between.align-items-center.w-100
        .d-flex.align-items-center
          .my-auto {{ siteName }}ç›£æ§å„€è¡¨æ¿
          lah-button(
            v-b-modal.help-modal,
            icon="info",
            variant="outline-success",
            no-border,
            no-icon-gutter,
            title="èªªæ˜"
          )

        .d-flex.align-items-center
          b-checkbox.mr-1.mt-2(
            v-model="col2",
            switch,
            size="lg"
          ) 2æ¬„é¡¯ç¤º
          .mr-1 ğŸ”´ {{ red }}
          .mr-1 ğŸŸ¡ {{ yellow }}
          .mr-1 ğŸŸ¢ {{ green }}
          b-button-group(size="lg")
            lah-button.mx-1(
              @click="$refs.setupModal.show()",
              icon="cog",
              variant="outline-secondary",
              action="clock",
              no-border,
              no-icon-gutter,
              title="è¨­å®šEMAILä¼ºæœå™¨"
            )
    lah-monitor-board-setup-modal(ref="setupModal")
    lah-help-modal(:modal-id="'help-modal'", size="lg", modal-title="æ™ºæ…§ç›£æ§å„€è¡¨æ¿èªªæ˜")
      h5.d-flex.align-items-center
        lah-fa-icon(icon="lightbulb" regular, variant="secondary")
        span.ml-2 åŠŸèƒ½ç¸½è¦½
      p æœ¬å„€è¡¨æ¿æ—¨åœ¨æä¾›ä¸€å€‹é›†ä¸­å¼çš„ç›£æ§ç•«é¢ï¼Œå³æ™‚é¡¯ç¤ºå„é …ç³»çµ±æœå‹™èˆ‡ç¡¬é«”è¨­å‚™çš„å¥åº·ç‹€æ…‹ã€‚
      hr
      h5.d-flex.align-items-center
        lah-fa-icon(icon="traffic-light", variant="secondary")
        span.ml-2 ç‡ˆè™Ÿèˆ‡ç‹€æ…‹
      ul
        li é é¢é ‚ç«¯æœƒå³æ™‚çµ±è¨ˆç›®å‰æ‰€æœ‰ç›£æ§é …ç›®çš„ç‡ˆè™Ÿæ•¸é‡ï¼š
          ul
            li ğŸ”´ #[strong ç´…ç‡ˆ]ï¼šè¡¨ç¤ºç›£æ§é …ç›®ç™¼ç”Ÿåš´é‡éŒ¯èª¤æˆ–ä¸­æ–·ã€‚
            li ğŸŸ¡ #[strong é»ƒç‡ˆ]ï¼šè¡¨ç¤ºç›£æ§é …ç›®å‡ºç¾è­¦å‘Šæˆ–æ½›åœ¨å•é¡Œã€‚
            li ğŸŸ¢ #[strong ç¶ ç‡ˆ]ï¼šè¡¨ç¤ºç›£æ§é …ç›®é‹ä½œæ­£å¸¸ã€‚
        li ç•¶ç›£æ§é …ç›®å‡ºç¾ #[strong ç´…ç‡ˆ] æˆ– #[strong é»ƒç‡ˆ] æ™‚ï¼Œå…¶ç›£æ§é¢æ¿å°‡æœƒè‡ªå‹•ç½®é ‚ï¼Œä¸¦é€éå‹•ç•«æ•ˆæœæé†’ç®¡ç†äººå“¡æ³¨æ„ã€‚
      hr
      h5.d-flex.align-items-center
        lah-fa-icon(icon="database", variant="secondary")
        span.ml-2 è³‡æ–™ä¾†æº
      p æœ¬å„€è¡¨æ¿é€éä»¥ä¸‹ä¸‰ç¨®æ–¹å¼ç²å–ç›£æ§æ•¸æ“šï¼š
      ol
        li #[strong é›»å­éƒµä»¶åˆ†æ]ï¼šè®€å–ç‰¹å®šéƒµä»¶ä¼ºæœå™¨çš„éƒµä»¶ï¼Œåˆ†æä¸»æ—¨èˆ‡å…§å®¹ä¾†åˆ¤æ–·æœå‹™ç‹€æ…‹ï¼ˆä¾‹å¦‚ï¼šSRMASã€è³‡æ–™åº«å‚™ä»½ç­‰ï¼‰ã€‚
        li #[strong æ™ºæ…§ç›£æ§API]ï¼šå‘¼å«å®‰è£æ–¼é ç«¯ä¼ºæœå™¨ä¸Šçš„å®¢è£½åŒ–APIï¼Œç²å–æœå‹™çš„å³æ™‚ç‹€æ…‹ï¼ˆä¾‹å¦‚ï¼šå»ºç‰©åœ–ç±åŒæ­¥ã€åœ°ç±ç•°å‹•å³æ™‚é€šç­‰ï¼‰ã€‚
        li #[strong ç³»çµ±å¾Œç«¯API]ï¼šç›´æ¥å­˜å–æœ¬ç³»çµ±å¾Œç«¯çš„APIï¼ŒæŸ¥è©¢å…§éƒ¨æœå‹™ç‹€æ…‹ï¼ˆä¾‹å¦‚ï¼šL3åŒæ­¥ã€è·¨ç¸£å¸‚APæœå‹™ç­‰ï¼‰ã€‚
      hr
      h5.d-flex.align-items-center
        lah-fa-icon(icon="columns", variant="secondary")
        span.ml-2 ç‰ˆé¢é…ç½®
      ul
        li å‹¾é¸é é¦–çš„ #[strong 2æ¬„é¡¯ç¤º] é–‹é—œï¼Œå¯ä»¥å°‡å„€è¡¨æ¿åœ¨å…©æ¬„èˆ‡ä¸‰æ¬„ä¹‹é–“åˆ‡æ›ï¼Œä»¥é©æ‡‰ä¸åŒçš„è¢å¹•å°ºå¯¸èˆ‡è§€çœ‹ç¿’æ…£ã€‚
      hr
      h5.d-flex.align-items-center
        lah-fa-icon(icon="cog", variant="secondary")
        span.ml-2 è¨­å®š
      ul
        li é»æ“Š #[lah-fa-icon(icon="cog")] æŒ‰éˆ•å¯ä»¥è¨­å®šç”¨æ–¼ #[strong é›»å­éƒµä»¶åˆ†æ] çš„éƒµä»¶ä¼ºæœå™¨é€£ç·šè³‡è¨Šã€‚

  //- ä½¿ç”¨ transition-group ä¾†å¯¦ç¾æ’åºå‹•ç•«
  //- é—œéµï¼škey å¿…é ˆæ˜¯ç©©å®šçš„ idï¼Œä¸èƒ½ä½¿ç”¨ index
  transition-group.d-flex.flex-wrap.align-content-start(
    tag="div",
    name="board-list"
  )
    div(
      v-for="board in sortedBoards"
      :key="board.id"
      :class="colCss"
    )
      component(
        :is="board.comp"
        :ref="toCamelCase(board.comp)"
        :id="toCamelCase(board.comp) + '-attention'"
        :class="[heightCss, board.extraClass]"
        v-bind="board.props"
        :footer="board.footer"
        @light-update="lightUpdate($event, board)"
      )

</template>

<script>
export default {
  // middleware: ['isInf'], // authority control
  data: () => ({
    red: 0,
    yellow: 0,
    green: 0,
    /** element in attentionList
     * e.g. {
     * compName: "lahMonitorBoardSrmas"
     * state: "danger"
     * }
     */
    attentionList: [],
    attentionTimer: null,
    topWarning: true,
    col2: false,
    // å®šç¾©æ‰€æœ‰é¢æ¿çš„é…ç½®
    boards: [
      { comp: 'lah-monitor-board-xap', footer: false },
      { comp: 'lah-monitor-board-xap-trend', footer: false, props: { watchTopXap: true, reloadTime: 15 } },
      { comp: 'lah-monitor-board-powerha', footer: true },
      { comp: 'lah-monitor-board-dataguard', footer: true },
      { comp: 'lah-monitor-board-srmas', footer: true, extraClass: 'fix-img' },
      { comp: 'lah-monitor-board-hacmp', footer: true },
      { comp: 'lah-monitor-board-sms-notify', footer: true },
      { comp: 'lah-monitor-board-sms', footer: true },
      { comp: 'lah-monitor-board-L05', footer: true },
      { comp: 'lah-monitor-board-apbackup', footer: true },
      { comp: 'lah-monitor-board-xcase-sync', footer: false },
      { comp: 'lah-monitor-board-site-hx', footer: false },
      { comp: 'lah-monitor-board-lxhweb', footer: false, props: { targetIp: 'L3HWEB', link: true, displayUpdateTime: true } },
      { comp: 'lah-monitor-board-site-tw', footer: false },
      { comp: 'lah-monitor-board-dbbackup', footer: true },
      { comp: 'lah-monitor-board-connectivity', footer: false }
    ]
  }),
  head: {
    title: 'æ™ºæ…§ç›£æ§å„€è¡¨æ¿-æ¡ƒåœ’å¸‚åœ°æ”¿å±€'
  },
  computed: {
    siteName () {
      return this.$store.getters['user/siteName'] || 'æœ¬æ‰€'
    },
    colCss () {
      return this.col2 ? ['col-md-6'] : ['col-md-4']
    },
    heightCss () {
      return this.col2 ? ['card-body-fixed-height-2'] : ['card-body-fixed-height-3']
    },
    dangerList () {
      return this.attentionList.filter((item) => {
        return item.state === 'danger'
      })
    },
    warningList () {
      return this.attentionList.filter((item) => {
        return item.state === 'warning'
      })
    },
    highlightCount () {
      return this.attentionList.length
    },
    lightMap () {
      return this.$store.getters['inf/monitorLightMap']
    },
    connectionText () {
      // bureau ssl mail server needs this
      if (this.systemConfigs?.monitor?.ssl) {
        return `${this.systemConfigs?.monitor?.account}@{${this.systemConfigs?.monitor?.host}:993/imap/ssl/novalidate-cert}INBOX`
      }
      return `${this.systemConfigs?.monitor?.account}@{${this.systemConfigs?.monitor?.host}/novalidate-cert}INBOX`
    },
    // å‹•æ…‹æ’åºåˆ—è¡¨ï¼šDanger(-2) > Warning(-1) > Normal(0)
    sortedBoards () {
      // è¤‡è£½ä¸€ä»½é™£åˆ—ä»¥å…ä¿®æ”¹åˆ°åŸå§‹è³‡æ–™ï¼Œé¿å…æ­¤è™•çš„ sort å½±éŸ¿åˆ°åŸå§‹ boards é †åº
      const list = [...this.boards]
      return list.sort((a, b) => {
        return this.getWeight(a) - this.getWeight(b)
      })
    }
  },
  watch: {
    col2 (flag) {
      this.setCache('dashboard-col2', flag)
    }
  },
  created () {
    // ç‚ºæ¯å€‹ board è³¦äºˆå”¯ä¸€çš„ IDï¼Œé€™å°æ–¼ transition-group çš„æ’åºå‹•ç•«è‡³é—œé‡è¦
    this.boards.forEach((board, index) => {
      // å»ºç«‹ä¸€å€‹åŸºç¤çš„å”¯ä¸€ IDï¼Œå¦‚æœæœ‰ IP å‰‡åŒ…å« IP ä»¥åˆ©è­˜åˆ¥
      const suffix = board.props?.serverIp ? `-${board.props.serverIp}` : ''
      // ä½¿ç”¨ non-reactive property å¯«å…¥ idï¼Œå› ç‚ºé€™å€‹ id æ°¸é ä¸æœƒè®Š
      board.id = `${board.comp}${suffix}-${index}`
      
      // åˆå§‹åŒ– realNameï¼Œæ–¹ä¾¿ Vue è¿½è¹¤éŸ¿æ‡‰
      this.$set(board, 'realName', null)
    })

    this.getCache('dashboard-col2').then((flag) => {
      this.col2 = flag
    })
  },
  mounted () {
    this.refreshHighlightGroup = this.$utils.debounce(() => {
      // to add warning/danger card to highlight group
      const tmp = []
      for (const [key, value] of this.lightMap) {
        if (['warning', 'danger'].includes(value)) {
          // æ³¨æ„ï¼šé€™è£¡å°‡ key è½‰ç‚ºé¦–å­—æ¯å°å¯« (camelCase)
          tmp.push({
            compName: key.charAt(0).toLowerCase() + key.slice(1),
            state: value
          })
        }
      }
      // order by state
      this.attentionList = this.$utils.orderBy(tmp, 'state')
    }, 5000)

    // using animation to catch attention
    this.attentionTimer = setInterval(() => {
      this.dangerList.forEach((card) => {
        this.timeout(
          // 'slower', 'slow', '', 'fast', 'faster' (3s, 2s, 1s, 800ms, 500ms)
          () => this.attention(`#${card.compName}-attention`, { speed: '1s' }),
          this.$utils.rand(15) * 1000
        )
      })
      this.warningList.forEach((card) => {
        this.timeout(
          // 'slower', 'slow', '', 'fast', 'faster' (3s, 2s, 1s, 800ms, 500ms)
          () => this.attention(`#${card.compName}-attention`, { name: 'headShake' }),
          this.$utils.rand(15) * 1000
        )
      })
    }, 30 * 1000)
    
    // åˆå§‹åŒ–æ™‚å…ˆåŸ·è¡Œä¸€æ¬¡
    this.refreshHighlightGroup()
  },
  beforeDestroy () {
    clearInterval(this.attentionTimer)
  },
  methods: {
    lightUpdate (payload, board) {
      // å‹•æ…‹ç¶å®šï¼šå°‡çµ„ä»¶ç™¼å‡ºçš„çœŸå¯¦åç¨±è¨˜éŒ„åˆ° board ç‰©ä»¶ä¸­
      if (board && payload && payload.name) {
        // æ›´æ–° board.realNameï¼Œè§¸ç™¼ computed é‡ç®—
        if (board.realName !== payload.name) {
          this.$set(board, 'realName', payload.name)
        }
      }

      this.lightMap.set(payload.name, payload.new)
      const tmp = [...this.lightMap]
      this.green = tmp.reduce((acc, item) => {
        return item[1] === 'success' ? acc + 1 : acc
      }, 0)
      this.yellow = tmp.reduce((acc, item) => {
        return item[1] === 'warning' ? acc + 1 : acc
      }, 0)
      this.red = tmp.reduce((acc, item) => {
        return item[1] === 'danger' ? acc + 1 : acc
      }, 0)
      this.refreshHighlightGroup()
    },
    refreshHighlightGroup () { /* placeholder for debouncing */ },
    isInAttention (name) {
      const clean = name[0]?.toUpperCase() + name?.slice(1)
      return this.lightMap.has(clean) &&
             this.lightMap.get(clean) !== 'success'
    },
    isFooterEnable (name) {
      if (name) {
        const opts = this.$refs[`${name[0]?.toUpperCase() + name?.slice(1)}`]?.$options
        const footer = opts?.propsData?.footer
        return footer
      }
      return false
    },
    // Helper to convert kebab-case to camelCase
    toCamelCase (str) {
      return str.replace(/-([a-z])/g, (g) => g[1].toUpperCase())
    },
    // çµ±ä¸€å°‡é¦–å­—æ¯è½‰å°å¯«ï¼Œç¢ºä¿èˆ‡ attentionList ä¸­çš„ compName æ ¼å¼ä¸€è‡´
    normalizeName (name) {
      if (!name) return ''
      return name.charAt(0).toLowerCase() + name.slice(1)
    },
    // è¨ˆç®—æ¬Šé‡ï¼šç´…ç‡ˆ -2, é»ƒç‡ˆ -1, æ­£å¸¸ 0 (ä¿æŒåŸé †åº)
    getWeight (board) {
      // 1. å–å¾—ç”¨æ–¼æ¯”å°çš„åç¨± (å„ªå…ˆ realNameï¼Œå…¶æ¬¡ compName)
      let searchName = board.realName || this.toCamelCase(board.comp)
      
      // 2. å‚™æ´é æ¸¬ (å¦‚æœéœ€è¦)
      if (!board.realName && board.comp.includes('printer') && board.props?.serverIp) {
         // HX.vue ç›®å‰æ²’æœ‰ printerï¼Œä½†ä¿ç•™æ­¤é‚è¼¯ä»¥é˜²æœªä¾†æ“´å……
      }

      // 3. çµ±ä¸€è½‰æˆé¦–å­—æ¯å°å¯«
      const normalizedSearchName = this.normalizeName(searchName)

      // 4. åœ¨ attentionList ä¸­æœå°‹
      const item = this.attentionList.find(x => {
        if (x.compName === normalizedSearchName) return true
        if (board.props?.serverIp && x.compName.includes(board.props.serverIp)) return true
        return false
      })

      if (item) {
        if (item.state === 'danger') return -2
        if (item.state === 'warning') return -1
      }
      return 0
    }
  }
}
</script>

<style lang="scss">
.monitor-dashboard {
  /* Ignored desktop font size settings */
  -webkit-text-size-adjust: 100%;
  -moz-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
  text-size-adjust: 100%;
  /* Force a base font size to avoid system scaling issues that break fixed-height layouts */
  font-size: 16px;
}
.highlight-group {
  border-bottom: 2px dashed gray;
  margin-bottom: 15px;
}
.col-md-4 > .card {
  height: calc((100vh - 150px) / 3);
  overflow: auto;
  margin-bottom: 1rem;
}
.col-md-6 > .card {
  height: calc((100vh - 150px) / 2);
  overflow: auto;
  margin-bottom: 1rem;
}
.fix-img {
  img {
    height: calc(100vh / 3 - 200px);
  }
}
/* åˆ—è¡¨æ’åºå‹•ç•« - å¿…é ˆé…åˆ transition-group ä½¿ç”¨ */
.board-list-move {
  transition: transform 1s;
}
</style>