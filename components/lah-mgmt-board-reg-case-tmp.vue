<template lang="pug">
b-card
  template(#header)
    .d-flex
      h6.mb-0.mr-auto #[lah-fa-icon(icon="3", size="lg")] ç™»è¨˜æ¡ˆä»¶æš«å­˜æª”  #[a.text-primary.font-weight-bold(href="#", @click="detail", title="é¡¯ç¤ºæ¡ˆä»¶è©³æƒ…") {{ $utils.caseId(caseId) }}]
      b-button-group(size="sm")
        lah-button(
          icon="question",
          action="breath",
          variant="outline-success",
          no-border,
          no-icon-gutter,
          @click="$refs.help.show()",
          title="ç™»è¨˜æ¡ˆä»¶ç‹€æ…‹ä¿®æ­£èªªæ˜"
        )
    lah-help-modal(ref="help", modal-title="ç™»è¨˜æ¡ˆä»¶æš«å­˜æª”èªªæ˜")
      ul.h5
        li: .d-flex.align-items-center
          div æœ¬é …åŠŸèƒ½å”åŠ©é¡¯ç¤ºæ¡ˆä»¶æš«å­˜æª”ç‹€æ…‹ã€‚
        li: .d-flex.align-items-center
          div å¦‚æ¬²æ¸…é™¤æš«å­˜æª”è«‹å…ˆé»é¸å‚™ä»½æŒ‰éˆ•å¾Œï¼Œå†é€²è¡Œåˆªé™¤ã€‚
      h6 ğŸ‘‰ æª¢æŸ¥ä¸‹åˆ—çš„è¡¨æ ¼
      ul
        li "MOICAT.RALID" => "A"   // åœŸåœ°æ¨™ç¤ºéƒ¨
        li "MOICAT.RBLOW" => "B"   // åœŸåœ°æ‰€æœ‰æ¬Šéƒ¨
        li "MOICAT.RCLOR" => "C"   // ä»–é …æ¬Šåˆ©éƒ¨
        li "MOICAT.RDBID" => "D"   // å»ºç‰©æ¨™ç¤ºéƒ¨
        li "MOICAT.REBOW" => "E"   // å»ºç‰©æ‰€æœ‰æ¬Šéƒ¨
        li "MOICAT.RLNID" => "L"   // äººæª”
        li "MOICAT.RRLSQ" => "R"   // æ¬Šåˆ©æ¨™çš„
        li "MOICAT.RGALL" => "G"   // å…¶ä»–ç™»è¨˜äº‹é …
        li "MOICAT.RMNGR" => "M"   // ç®¡ç†è€…
        li "MOICAT.RTOGH" => "T"   // ä»–é …æ¬Šåˆ©æª”
        li "MOICAT.RHD10" => "H"   // åŸºåœ°åè½ï¼åœ°ä¸Šå»ºç‰©
        li.text-danger "MOICAT.RINDX" => "II"  // æ¡ˆä»¶ç•°å‹•ç´¢å¼•ã€ä¸æœƒæ¸…é™¤ã€‘
        li "MOICAT.RINXD" => "ID"
        li "MOICAT.RINXR" => "IR"
        li "MOICAT.RINXR_EN" => "IRE"
        li "MOICAT.RJD14" => "J"
        li "MOICAT.ROD31" => "O"
        li "MOICAT.RPARK" => "P"
        li "MOICAT.RPRCE" => "PB"
        li "MOICAT.RSCNR" => "SR"
        li "MOICAT.RSCNR_EN" => "SRE"
        li "MOICAT.RVBLOW" => "VB"
        li "MOICAT.RVCLOR" => "VC"
        li "MOICAT.RVGALL" => "VG"
        li "MOICAT.RVMNGR" => "VM"
        li "MOICAT.RVPON" => "VP"  // é‡æ¸¬/é‡åŠƒæš«å­˜
        li "MOICAT.RVRLSQ" => "VR"
        li "MOICAT.RXIDD04" => "ID"
        li "MOICAT.RXLND" => "XL"
        li "MOICAT.RXPRI" => "XP"
        li "MOICAT.RXSEQ" => "XS"
        li "MOICAT.B2104" => "BR"
        li "MOICAT.B2118" => "BR"
        li "MOICAT.BGALL" => "G"
        li "MOICAT.BHD10" => "H"
        li "MOICAT.BJD14" => "J"
        li "MOICAT.BMNGR" => "M"
        li "MOICAT.BOD31" => "O"
        li "MOICAT.BPARK" => "P"
        li "MOICAT.BRA26" => "C"
        li "MOICAT.BRLSQ" => "R"
        li "MOICAT.BXPRI" => "XP"
        li "MOICAT.DGALL" => "G"
        //- åœ°åƒ¹
        li "MOIPRT.PPRCE" => "MA"
        li "MOIPRT.PGALL" => "GG"
        li "MOIPRT.PBLOW" => "LA"
        li "MOIPRT.PALID" => "KA"
        li "MOIPRT.PNLPO" => "NA"
        li "MOIPRT.PBLNV" => "BA"
        li "MOIPRT.PCLPR" => "CA"
        li "MOIPRT.PFOLP" => "FA"
        li "MOIPRT.PGOBP" => "GA"
        li "MOIPRT.PAPRC" => "AA"
        li "MOIPRT.PEOPR" => "EA"
        li "MOIPRT.POA11" => "OA"
        li "MOIPRT.PGOBPN" => "GA"
        // <li>"MOIPRC.PKCLS" => "KK"</li>
        li "MOIPRT.PPRCE" => "MA"
        li "MOIPRT.P76SCRN" => "SS"
        li "MOIPRT.P21T01" => "TA"
        li "MOIPRT.P76ALID" => "AS"
        li "MOIPRT.P76BLOW" => "BS"
        li "MOIPRT.P76CRED" => "BS"
        li "MOIPRT.P76INDX" => "II"
        li "MOIPRT.P76PRCE" => "UP"
        li "MOIPRT.P76SCRN" => "SS"
        li "MOIPRT.PAE0301" => "MA"
        li "MOIPRT.PB010" => "TP"
        li "MOIPRT.PB014" => "TB"
        li "MOIPRT.PB015" => "TB"
        li "MOIPRT.PB016" => "TB"
        li.text-danger "MOIPRT.PHIND" => "II"  // æ¡ˆä»¶ç•°å‹•ç´¢å¼•ã€ä¸æœƒæ¸…é™¤ã€‘
        li "MOIPRT.PNLPO" => "NA"
        li "MOIPRT.POA11" => "OA"

  h5.center(v-if="!dataReady"): lah-fa-icon(icon="triangle-exclamation", variant="warning") è«‹å…ˆæœå°‹æ¡ˆä»¶ï¼
  div(v-else)
    div(v-if="found")
      div(v-for="(item, idx) in filtered")
        h6.font-weight-bold.text-center(v-if="idx == 0")
          lah-fa-icon(icon="triangle-exclamation", variant="warning") è«‹æª¢æŸ¥ä¸‹åˆ—æš«å­˜æª”è³‡è¨Šï¼Œå¿…è¦æ™‚è«‹åˆªé™¤ã€‚
        b-button(@click="showSQL(item)" size="sm" variant="warning")
          | {{ item[0] }}è¡¨æ ¼
          span.badge.badge-light.ml-1
            | {{ item[1].length }}
            span.sr-only æš«å­˜æª”æ•¸é‡
        small.ml-1
          b-button(:id="'backup_temp_btn_' + idx" size="sm" variant="outline-primary" @click="backup(item, idx, $event)") å‚™ä»½
          b-button.ml-1(v-if="item[0] != 'MOICAT.RINDX' && item[0] != 'MOIPRT.PHIND'" :title="title(item)" size="sm" variant="outline-danger" @click="clean(item, idx, $event)") æ¸…é™¤
        .small.my-2 ï¼â€ƒ{{ item[2] }}
      hr
      .text-center
        b-button#backup_temp_btn_all(@click="backupAll" variant="outline-primary" size="sm") å…¨éƒ¨å‚™ä»½
        b-button.ml-1(@click="cleanAll" variant="danger" size="sm") å…¨éƒ¨æ¸…é™¤
    lah-fa-icon(v-if="notFound" icon="exclamation-circle" variant="success" size="lg") ç„¡æš«å­˜æª”ã€‚
    lah-fa-icon(v-if="loading" action="spin" icon="spinner" size="lg") è®€å–ä¸­
</template>

<script>
import lahRegCaseDetailVue from './lah-reg-case-detail.vue'
export default {
  components: { lahRegCaseDetailVue },
  data: () => ({
    filtered: null,
    cleanAllBackupFlag: false,
    backupFlags: []
  }),
  computed: {
    caseId () {
      if (this.dataReady) {
        return this.crsmsData?.ID
      }
      return ''
    },
    dataReady () {
      return !this.$utils.empty(this.crsmsData)
    },
    crsmsData () {
      return this.$store.getters['inf/crsmsData']
    },
    year () {
      return this.crsmsData?.RM01 || ''
    },
    code () {
      return this.crsmsData?.RM02 || ''
    },
    number () {
      return this.crsmsData?.RM03 || ''
    },
    found () {
      return !this.$utils.empty(this.filtered)
    },
    notFound () {
      return Array.isArray(this.filtered) && this.$utils.empty(this.filtered)
    },
    loading () {
      return this.filtered === null
    },
    prefix () {
      return `${this.year}-${this.code}-${this.number}`
    }
  },
  watch: {
    crsmsData (dontcare) {
      this.filtered = null
      this.query()
    }
  },
  created () {
    this.busyIconSize = '1x'
    this.query = this.$utils.debounce(() => {
      if (
        !this.$utils.empty(this.year) &&
        !this.$utils.empty(this.code) &&
        !this.$utils.empty(this.number)
      ) {
        this.isBusy = true
        this.$axios.post(this.$consts.API.JSON.QUERY, {
          type: 'query_temp_data',
          year: this.year,
          code: this.code,
          number: this.number
        }).then((res) => {
          console.assert(res.data.status === this.$consts.XHR_STATUS_CODE.SUCCESS_NORMAL, `æŸ¥è©¢æš«å­˜è³‡æ–™å›å‚³ç‹€æ…‹ç¢¼æœ‰å•é¡Œã€${res.data.status}ã€‘`)

          this.filtered = []
          // res.data.raw structure: 0 - Table, 1 - all raw data, 2 - SQL
          this.filtered = res.data.raw?.filter((item, index, array) => {
            return item[1]?.length > 0
          })
          // initialize backup flag array for backup detection
          this.backupFlags = Array(this.filtered?.length).fill(false)
        }).catch((err) => {
          this.$utils.error(err)
        }).finally(() => {
          this.isBusy = false
        })
      }
    }, 1000)
  },
  mounted () {},
  methods: {
    detail () {
      this.modal(this.$createElement(lahRegCaseDetailVue, {
        props: {
          caseId: this.caseId,
          parentData: this.crsmsData
        }
      }), {
        title: `ç™»è¨˜æ¡ˆä»¶è©³æƒ… ${this.$utils.caseId(this.caseId)}`,
        size: 'xl'
      })
    },
    title (item) {
      return item[0] === 'MOICAT.RINDX' || item[0] === 'MOIPRT.PHIND' ? 'é‡è¦æ¡ˆä»¶ç´¢å¼•ï¼Œç„¡æ³•åˆªé™¤ï¼' : ''
    },
    download (content, filename) {
      const url = window.URL.createObjectURL(new Blob([content]))
      const link = document.createElement('a')
      link.href = url
      link.setAttribute('download', filename)
      document.body.appendChild(link)
      link.click()
      // afterwards we remove the element again
      link.remove()
      // release object in memory
      window.URL.revokeObjectURL(url)
    },
    backupAll (e) {
      this.isBusy = true
      const filename = this.year + '-' + this.code + '-' + this.number + '-TEMP-DATA.sql'
      let allContent = ''
      this.filtered.forEach((item, idx) => {
        allContent += this.getInsSQL(item)
      })
      this.download(allContent, filename)
      this.cleanAllBackupFlag = true
      this.isBusy = false
    },
    cleanAll (e) {
      if (this.cleanAllBackupFlag !== true) {
        this.alert('è«‹å…ˆå‚™ä»½ï¼', {
          title: 'æ¸…é™¤å…¨éƒ¨æš«å­˜è³‡æ–™',
          subtitle: `${this.year}-${this.code}-${this.number}`
        })
        this.attention('#backup_temp_btn_all', { name: 'tada' })
      } else {
        const msg = "<h6><strong class='text-danger'>â˜…è­¦å‘Šâ˜…</strong>ï¼šç„¡æ³•å¾©åŸè«‹å…ˆå‚™ä»½!!</h6>æ¸…é™¤æ¡ˆä»¶ " + this.year + '-' + this.code + '-' + this.number + ' å…¨éƒ¨æš«å­˜æª”?'
        this.confirm(
          msg,
          { title: 'è­¦å‘Šï¼Œè«‹å…ˆå‚™ä»½' }
        ).then((YN) => {
          if (YN) {
            this.isBusy = true
            this.$axios.post(this.$consts.API.JSON.QUERY, {
              type: 'clear_temp_data',
              year: this.year,
              code: this.code,
              number: this.number,
              table: ''
            }).then((res) => {
              console.assert(res.data.status === this.$consts.XHR_STATUS_CODE.SUCCESS_NORMAL, 'æ¸…é™¤æš«å­˜è³‡æ–™å›å‚³ç‹€æ…‹ç¢¼æœ‰å•é¡Œã€' + res.data.status + 'ã€‘')
              this.success('å·²æ¸…é™¤å®Œæˆã€‚<p>' + this.year + '-' + this.code + '-' + this.number + '</p>', {
                title: 'æ¸…é™¤æš«å­˜æª”'
              })
              this.$(e.target).remove()
            }).catch((err) => {
              this.$utils.error(err)
            }).finally(() => {
              this.isBusy = false
            })
          }
        })
      }
    },
    backup (item, idx, e) {
      this.isBusy = true
      const filename = `${this.prefix}-${item[0]}-TEMP-DATA.sql`
      this.download(this.getInsSQL(item), filename)
      this.backupFlags[idx] = true
      this.$(e.target).attr('disabled', this.backupFlags[idx])
      this.isBusy = false
    },
    clean (item, idx, e) {
      const table = item[0]
      if (this.backupFlags[idx] !== true) {
        this.alert({
          title: `æ¸…é™¤ ${table} æš«å­˜æª”`,
          subtitle: `${this.year}-${this.code}-${this.number}`,
          message: `è«‹å…ˆå‚™ä»½ ${table} ï¼`
        })
        this.attention(`#backup_temp_btn_${idx}`, { name: 'tada' })
      } else {
        const msg = "<h6><strong class='text-danger'>â˜…è­¦å‘Šâ˜…</strong>ï¼šç„¡æ³•å¾©åŸè«‹å…ˆå‚™ä»½!!</h6>æ¸…é™¤æ¡ˆä»¶ " + this.year + '-' + this.code + '-' + this.number + ' ' + table + ' æš«å­˜æª”?'
        this.confirm(
          msg,
          { title: 'è­¦å‘Šï¼Œè«‹å…ˆå‚™ä»½ï¼' }
        ).then((YN) => {
          if (YN) {
            this.isBusy = true
            this.$http.post(this.$consts.API.JSON.QUERY, {
              type: 'clear_temp_data',
              year: this.year,
              code: this.code,
              number: this.number,
              table
            }).then((res) => {
              console.assert(res.data.status === this.$consts.XHR_STATUS_CODE.SUCCESS_NORMAL, 'æ¸…é™¤æš«å­˜è³‡æ–™å›å‚³ç‹€æ…‹ç¢¼æœ‰å•é¡Œã€' + res.data.status + 'ã€‘')
              this.success('å·²æ¸…é™¤å®Œæˆã€‚', {
                title: `æ¸…é™¤ ${table} æš«å­˜æª”`,
                subtitle: this.year + '-' + this.code + '-' + this.number
              })
              this.$(e.target).remove()
            }).catch((err) => {
              this.$utils.error(err)
            }).finally(() => {
              this.isBusy = false
            })
          }
        })
      }
    },
    showSQL (item) {
      this.modal(this.getInsSQL(item).replace(/\n/g, '<br /><br />'), {
        title: `INSERT SQL of ${item[0]}`,
        html: true,
        size: 'xl'
      })
    },
    getInsSQL (item) {
      let INS_SQL = ''
      for (let y = 0; y < item[1]?.length; y++) {
        const thisRow = item[1][y]
        const fields = []
        const values = []
        for (const key in thisRow) {
          fields.push(key)
          values.push(this.$utils.empty(thisRow[key]) ? 'null' : `'${thisRow[key]}'`)
        }
        INS_SQL += `insert into ${item[0]} (${fields.join(',')})`
        INS_SQL += ` values (${values.join(',')});\n`
      }
      return INS_SQL
    }
  }
}
</script>

<style lang="scss" scoped>
</style>
